# TON API Incremental Indexer

–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å–∞—Ç–æ—Ä –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ö –∏–∑ TON-–±–ª–æ–∫—á–µ–π–Ω–∞ —á–µ—Ä–µ–∑ API `tonapi.io`.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üîÑ **–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è** - –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –∫—É—Ä—Å–æ—Ä–∞
- üì° **GraphQL + REST API** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ GraphQL –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∏ REST –¥–ª—è –∏–Ω—Å–ø–µ–∫—Ü–∏–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤
- ‚ö° **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–¥–æ 4)
- üîÑ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–µ—Ç–∏ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
- üìÅ **–£–º–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- üìù **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
- üõ°Ô∏è **Graceful shutdown** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –ø–æ —Å–∏–≥–Ω–∞–ª–∞–º
- üîÑ **–û–±—Ä–∞–±–æ—Ç–∫–∞ Rate Limits (429)** - –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –ª–∏–º–∏—Ç–æ–≤ API:
  - –ß—Ç–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `Retry-After` –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
  - –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞
  - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 60 —Å–µ–∫—É–Ω–¥
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö rate limit —Å–æ–±—ã—Ç–∏–π

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Node.js >= 18.0.0
- npm –∏–ª–∏ yarn
- API –∫–ª—é—á –æ—Ç tonapi.io

### –®–∞–≥–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏

1. **–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:**
```bash
git clone <repository-url>
cd ton-api-indexing
npm install
```

2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
```bash
cp env.example .env
```

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `.env` —Ñ–∞–π–ª:
```env
TONAPI_KEY=your_api_key_here
TONAPI_GRAPHQL_URL=https://tonapi.io/v2/graphql
TONAPI_REST_URL=https://tonapi.io/v2
CURSOR_FILE_PATH=./cursor.txt
DATA_DIRECTORY=./data
MAX_CONCURRENT_REQUESTS=4
ACCOUNTS_PER_PAGE=100
LOG_LEVEL=info
```

3. **–°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞:**
```bash
npm run build
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –†–µ–∂–∏–º—ã –∑–∞–ø—É—Å–∫–∞

#### –û–¥–Ω–∞ –∏—Ç–µ—Ä–∞—Ü–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è cron)
```bash
npm start
# –∏–ª–∏
node dist/index.js
```

#### –ü–æ–ª–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è (–≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
```bash
npm start complete
# –∏–ª–∏
node dist/index.js complete
```

#### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å hot-reload
```bash
npm run dev
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron

–î–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –¥–æ–±–∞–≤—å—Ç–µ –≤ crontab:

```bash
# –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
*/5 * * * * cd /path/to/ton-api-indexing && npm start >> /var/log/ton-indexer.log 2>&1

# –ö–∞–∂–¥—ã–π —á–∞—Å
0 * * * * cd /path/to/ton-api-indexing && npm start

# –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 02:00
0 2 * * * cd /path/to/ton-api-indexing && npm start
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|--------------|----------|
| `TONAPI_KEY` | - | **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ**: API –∫–ª—é—á –æ—Ç tonapi.io |
| `TONAPI_GRAPHQL_URL` | `https://tonapi.io/v2/graphql` | GraphQL endpoint |
| `TONAPI_REST_URL` | `https://tonapi.io/v2` | REST API base URL |
| `CURSOR_FILE_PATH` | `./cursor.txt` | –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å –∫—É—Ä—Å–æ—Ä–æ–º |
| `DATA_DIRECTORY` | `./data` | –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è JSON —Ñ–∞–π–ª–æ–≤ |
| `MAX_CONCURRENT_REQUESTS` | `4` | –ú–∞–∫—Å–∏–º—É–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ |
| `REQUEST_DELAY_MS` | `100` | –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ |
| `ACCOUNTS_PER_PAGE` | `100` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å |
| `MAX_RETRIES` | `3` | –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ |
| `RETRY_DELAY_MS` | `1000` | –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–≤—Ç–æ—Ä–∞–º–∏ |
| `LOG_LEVEL` | `info` | –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (`debug`, `info`, `warn`, `error`) |
| `LOG_PRETTY` | `false` | –ö—Ä–∞—Å–∏–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤ |

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
ton-api-indexing/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts           # –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GraphQLClient.ts   # GraphQL –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RestClient.ts      # REST API –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ IndexerService.ts  # –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts           # TypeScript —Ç–∏–ø—ã
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fileUtils.ts       # –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger.ts          # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îî‚îÄ‚îÄ index.ts               # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ data/                      # –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ JSON —Ñ–∞–π–ª—ã
‚îú‚îÄ‚îÄ cursor.txt                 # –§–∞–π–ª —Å –∫—É—Ä—Å–æ—Ä–æ–º
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îî‚îÄ‚îÄ README.md
```

### –§–æ—Ä–º–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

–§–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
- –ò–º—è —Ñ–∞–π–ª–∞: `inspect_{rawAddress_with_underscores}.json`
- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ: –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ `/blockchain/accounts/{address}/inspect`

–ü—Ä–∏–º–µ—Ä:
```
data/inspect_0_11bb825750ffcffc4cebc7846910a87f3.json
```

## API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### GraphQL –∑–∞–ø—Ä–æ—Å
```graphql
query($first: Int!, $after: Cursor) {
  allAccounts(first: $first, after: $after) {
    pageInfo {
      hasNextPage
      endCursor
    }
    nodes {
      rawAddress
    }
  }
}
```

### REST endpoint
```
GET https://tonapi.io/v2/blockchain/accounts/{rawAddress}/inspect
Authorization: Bearer {API_KEY}
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π `pino`. –í—Å–µ –ª–æ–≥–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

### –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

- **debug**: –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
- **info**: –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ö–æ–¥–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- **warn**: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
- **error**: –û—à–∏–±–∫–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤

```json
{
  "level": "INFO",
  "time": "2024-01-15T10:30:00.000Z",
  "name": "ton-indexer",
  "msg": "Successfully fetched accounts",
  "accountsCount": 100,
  "hasNextPage": true,
  "endCursor": "eyJhZGRyZXNzIjoiMCJ9"
}
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—É—Ä—Å–æ—Ä–∞:**
```bash
cat cursor.txt
```

2. **–ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ª–æ–≥–æ–≤:**
```bash
npm start 2>&1 | tail -f
```

3. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤:**
```bash
ls -la data/ | wc -l
```

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
```
API error (401): Unauthorized
```
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å API –∫–ª—é—á–∞ –≤ `.env`

#### –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤
```
API error (429): Too Many Requests
```
**–†–µ—à–µ–Ω–∏–µ**: –£–º–µ–Ω—å—à–∏—Ç–µ `MAX_CONCURRENT_REQUESTS` –∏–ª–∏ —É–≤–µ–ª–∏—á—å—Ç–µ `REQUEST_DELAY_MS`

#### –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏
```
Network error: ECONNRESET
```
**–†–µ—à–µ–Ω–∏–µ**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã –≤–∫–ª—é—á–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.

## –†–∞–∑–≤–∏—Ç–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```bash
npm test
```

### –õ–∏–Ω—Ç–∏–Ω–≥
```bash
npm run lint
```

### –°–±–æ—Ä–∫–∞
```bash
npm run build
```

### –û—á–∏—Å—Ç–∫–∞
```bash
npm run clean
```

## Docker (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY dist/ ./dist/
CMD ["node", "dist/index.js"]
```

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –∫–æ–º–∞–Ω–¥–µ TON Foundation. 