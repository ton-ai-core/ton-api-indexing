name: TON Blockchain Indexer

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:
    # Allow manual trigger
    inputs:
      duration_minutes:
        description: 'Duration to run indexer (minutes)'
        required: false
        default: '9'
        type: string

# Grant write permissions for commits
permissions:
  contents: write

concurrency:
  group: ton-indexer
  cancel-in-progress: false

jobs:
  index:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # Fetch full history to ensure proper commits
        fetch-depth: 0
        # Use default token with write permissions
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Configure Git
      run: |
        git config --global user.name 'TON Indexer Bot'
        git config --global user.email 'indexer@github-actions.local'

    - name: Create .env file
      run: |
        echo "TONAPI_KEY=AFPJTKEBPOX3AIYAAAAKA2HWOTRNJP5MUCV5DMDCZAAOCPSAYEYS3CILNQVLF2HWKED6USY" > .env
        echo "LOG_LEVEL=info" >> .env
        echo "LOG_PRETTY=false" >> .env
        echo "MAX_CONCURRENT_REQUESTS=3" >> .env
        echo "ACCOUNTS_PER_PAGE=50" >> .env
        echo "REQUEST_DELAY_MS=100" >> .env

    - name: Ensure data directory exists
      run: mkdir -p data

    - name: Run TON Indexer (Timed Mode)
      run: |
        DURATION=${{ github.event.inputs.duration_minutes || '9' }}
        echo "ðŸš€ Starting TON indexer for ${DURATION} minutes..."
        npm run build
        timeout 540s node dist/index.js timed ${DURATION} || echo "â° Indexer completed (timeout or finished)"

    - name: Check for changes
      id: changes
      run: |
        git add data/ cursor.txt
        if git diff --staged --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "ðŸ“ No changes to commit"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ“ Changes detected"
        fi

    - name: Commit and push changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        # Get some stats for the commit message
        DATA_FILES=$(find data -name "*.json" | wc -l)
        NEW_FILES=$(git diff --staged --name-only --diff-filter=A | grep -E "\.json$" | wc -l)
        CURSOR_UPDATED=$(git diff --staged --name-only | grep cursor.txt | wc -l)
        
        # Create commit message
        TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
        COMMIT_MSG="ðŸ¤– Automated indexing: ${TIMESTAMP}

        ðŸ“Š Stats:
        - Total contract files: ${DATA_FILES}
        - New contracts in this run: ${NEW_FILES}
        - Cursor updated: $([ ${CURSOR_UPDATED} -eq 1 ] && echo 'Yes' || echo 'No')
        
        Generated by GitHub Actions workflow"
        
        git commit -m "${COMMIT_MSG}"
        git push

    - name: Log indexing summary
      if: always()
      run: |
        echo "ðŸ“ˆ Indexing Summary:"
        echo "- Total JSON files: $(find data -name "*.json" | wc -l 2>/dev/null || echo 0)"
        echo "- Data directory size: $(du -sh data 2>/dev/null | cut -f1 || echo '0B')"
        echo "- Cursor file exists: $([ -f cursor.txt ] && echo 'Yes' || echo 'No')"
        if [ -f cursor.txt ]; then
          echo "- Current cursor: $(cat cursor.txt 2>/dev/null || echo 'empty')"
        fi 
