name: TON Blockchain Indexer

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      duration_minutes:
        description: 'Duration to run indexer (minutes)'
        required: false
        default: '9'
        type: string

permissions:
  contents: write

concurrency:
  group: ton-indexer
  cancel-in-progress: false

jobs:
  index:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        persist-credentials: true
        filter: 'blob:none'
        sparse-checkout: |
          /*
          !/data
        sparse-checkout-cone-mode: false

    - name: Check disk usage after sparse checkout
      run: |
        echo "After sparse checkout:"
        df -h /
        echo "Root directory contents:"
        ls -d */

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Configure Git
      run: |
        git config --global user.name  "TON Indexer Bot"
        git config --global user.email "indexer@github-actions.local"

    - name: Create .env file
      run: |
        cat <<EOF > .env
        TONAPI_KEY=AFPJTKEBPOX3AIYAAAAKA2HWOTRNJP5MUCV5DMDCZAAOCPSAYEYS3CILNQVLF2HWKED6USY
        LOG_LEVEL=info
        LOG_PRETTY=false
        MAX_CONCURRENT_REQUESTS=3
        ACCOUNTS_PER_PAGE=50
        REQUEST_DELAY_MS=100
        EOF

    - name: Ensure data directory exists
      run: mkdir -p data

    - name: Run TON Indexer (timed mode)
      run: |
        DURATION=${{ github.event.inputs.duration_minutes || '9' }}
        echo "ðŸš€ Starting TON indexer for ${DURATION} minutesâ€¦"
        npm run build
        timeout $((DURATION * 60)) node dist/index.js timed "${DURATION}" \
          || echo "â° Indexer finished (timeout or graceful exit)"

    - name: Stage changes
      id: changes
      run: |
        git add data/ cursor.txt
        if git diff --staged --quiet; then
          echo "has_changes=false" >> "$GITHUB_OUTPUT"
          echo "ðŸ“ No changes to commit"
        else
          echo "has_changes=true"  >> "$GITHUB_OUTPUT"
          echo "ðŸ“ Changes detected"
        fi

    - name: Commit â†’ clean â†’ rebase â†’ push
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        DATA_FILES=$(find data -name '*.json' | wc -l)
        NEW_FILES=$(git diff --staged --name-only --diff-filter=A | wc -l)
        CURSOR_UPDATED=$(git diff --staged --name-only | grep -c cursor.txt)
        TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

        COMMIT_MSG=$(
          echo "ðŸ¤– Automated indexing: ${TIMESTAMP}"
          echo
          echo "ðŸ“Š Stats:"
          echo "- Total contract files: ${DATA_FILES}"
          echo "- New contracts this run: ${NEW_FILES}"
          echo "- Cursor updated: $([ ${CURSOR_UPDATED} -eq 1 ] && echo 'Yes' || echo 'No')"
          echo
          echo "Generated by GitHub Actions workflow"
        )
        git commit -m "$COMMIT_MSG"

        git clean -fd

        git pull --rebase --autostash origin main

        git push --force-with-lease

    - name: Indexing summary
      if: always()
      run: |
        echo "ðŸ“ˆ Indexing Summary:"
        echo "- Total JSON files: $(find data -name '*.json' | wc -l || echo 0)"
        echo "- Data directory size: $(du -sh data 2>/dev/null | cut -f1 || echo '0B')"
        echo "- Cursor file exists: $([ -f cursor.txt ] && echo 'Yes' || echo 'No')"
        [ -f cursor.txt ] && echo "- Current cursor: $(cat cursor.txt)"
